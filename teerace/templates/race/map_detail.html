{% extends "race/map_base.html" %}{% load race_diff %}{% load humanize %}
{% comment %}
context variables:
	map
	best_runs
	latest_runs
	user_runs
{% endcomment %}
{% block title %}{{ map.name }} - {{ block.super }}{% endblock title %}
{% block breadcrumb %}
	{{ block.super }}
	{% load breadcrumb_tags %}
	{% add_crumb map.name 'map_detail' map.id %}
{% endblock %}
{% block content %}
	<div class="box full">
		<div class="header"><a href="{{ map.get_absolute_url }}">{{ map.name }}</a></div>
		<div class="left detail">
			<table>
				<tr>
					<td class="label">Author</td>
					<td class="content">{{ map.author }}</td>
				</tr>
				<tr>
					<td class="label">Added</td>
					<td class="content">{{ map.added_at }}</td>
				</tr>
				<tr>
					<td class="label">Map downloads</td>
					<td class="content">{{ map.download_count }}</td>
				</tr>
			{% if map.best_score %}
				<tr>
					<td class="label">Best result</td>
					<td class="content">{{ map.best_score.time|floatformat:settings.RESULT_PRECISION }} by {{ map.best_score.user }}{% if map.best_score.nickname %} ({{ map.best_score.nickname }}){% endif %}</td>
				</tr>
			{% endif %}
				<tr>
					<td class="label">Average time</td>
					<td class="content">{% if map.average_score %}{{ map.average_score|floatformat:settings.RESULT_PRECISION }}{% else %}-{% endif %}</td>
				</tr>
				<tr>
					<td class="label">Map completions</td>
					<td class="content">{{ map.run_count }}</td>
				</tr>
				<tr>
					<td class="label">Map characteristics</td>
					<td class="content">
						<img src="{{ MEDIA_URL }}images/shield.png" alt="shield" title="How many shields are on this map"><div>{{ map.shield_count }}</div>
						<img src="{{ MEDIA_URL }}images/heart.png" alt="heart" title="How many hearts are on this map"><div>{{ map.heart_count }}</div>
						<img src="{{ MEDIA_URL }}images/grenade.png" alt="grenade" title="How many grenades are on this map"><div>{{ map.grenade_count }}</div>
						{% if map.has_unhookables %}<img src="{{ MEDIA_URL }}images/unhookable.png" alt="unhookable" title="There are unhookable tiles">{% endif %}
						{% if map.has_deathtiles %}<img src="{{ MEDIA_URL }}images/deathtiles.png" alt="deathtiles" title="There are death tiles">{% endif %}
					</td>
				</tr>
<!--
				<tr>
					<td class="label"></td>
					<td class="content"></td>
				</tr>
-->
			</table>
			<br>
			<a class="button" href="{% url map_download map.id %}">Download map</a>&nbsp;({{ map.map_file.size|filesizeformat }})
		</div>

		<div class="right detail no-map-image">
			<div>Map screenshot missing</div>
		</div>
	</div>
	<div class="box full">
		<div class="header">Top 5</div>
		<table>
			<tr>
				<th>#</th>
				<th>Player</th>
				<th>Points</th>
				<th>Date</th>
				<th>Time</th>
				<th>Diff</th>
			</tr>
			{% for best_run in best_runs %}
			<tr>
				<td>{{ best_run.position|ordinal }}</td>
				<td><a href="{{ best_run.user.get_absolute_url }}">{{ best_run.user.username }}</a></td>
				<td>{{ best_run.points }}</td>
				<td><span title="{{ best_run.run.created_at }}">{{ best_run.run.created_at|timesince }} ago</span></td>
				<td>{{ best_run.run.time|floatformat:settings.RESULT_PRECISION }}</td>
				<td>{% race_diff best_run.run map.best_score "-" %}</td>
			</tr>
			{% empty %}
			<tr>
				<td colspan="4">Hey! Nobody finished this map yet!</td>
			</tr>
			{% endfor %}
		{% if best_runs %}
		<tfoot>
			<tr>
				<td colspan="6"><a href="{% url ranks_map_detail map.id %}">See whole rank &raquo;</a></td>
			</tr>
		</tfoot>
		{% endif %}
		</table>
	</div>
	{% if latest_runs %}
	<div class="box full">
		<div class="header">Recent map completions</div>
		<table>
			<tr>
				<th>Player</th>
				<th>Date</th>
				<th>Time</th>
				<th>Diff (PB)</th>
				<th></th>
			</tr>
			{% for run in latest_runs %}
			<tr>
				<td>{{ run.user }}</td>
				<td>{{ run.created_at|timesince }} ago</td>
				<td>{{ run.time|floatformat:settings.RESULT_PRECISION }}</td>
				<td>{% diff_color run.diff_from_personal_best %}</td>
				<td>{% if run.is_personal_best %}PB!{% endif %}{% if run.was_personal_best %}old PB{% endif %}{% if run.is_record %}WR!{% endif %}{% if run.was_record %}was WR{% endif %}</td>
			</tr>
			{% endfor %}
		</table>
	</div>
	{% endif %}
	{% if user.is_authenticated %}
	<div class="box full">
		<div class="header">Your results</div>
		<table>
			<tr>
				<th>Date</th>
				<th>Time</th>
				<th>Diff (PB)</th>
				<th></th>
			</tr>
			{% for run in user_runs %}
			<tr>
				<td>{{ run.created_at|timesince }} ago</td>
				<td>{{ run.time|floatformat:settings.RESULT_PRECISION }}</td>
				<td>{% diff_color run.diff_from_personal_best %}</td>
				<td>{% if run.is_personal_best %}PB!{% endif %}{% if run.was_personal_best %}old PB{% endif %}{% if run.is_record %}WR!{% endif %}{% if run.was_record %}was WR{% endif %}</td>
			</tr>
			{% empty %}
			<tr>
				<td colspan="4">Hey! You haven't finished this map yet!</td>
			</tr>
			{% endfor %}
		</table>
	</div>
	{% endif %}
{% endblock %}
